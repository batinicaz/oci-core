name: Lint & Plan
on:
  workflow_dispatch:
  push:
    branches:
      - "**"
      - "!main"
permissions:
  contents: read
jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Run pre-commit
        uses: batinicaz/gha/.github/actions/pre-commit@12cd71cfcad257813483b7d5fcaf26191e3b86f9 # ratchet:batinicaz/gha/.github/actions/pre-commit@v1.2.5
  terraform:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # ratchet:hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.4

      - name: Fetch common secrets from Infisical
        uses: Infisical/secrets-action@8802effbe453d0576cd923567dcc2c97a1f54058 # ratchet:Infisical/secrets-action@v1.0.15
        with:
          domain: https://eu.infisical.com
          method: oidc
          oidc-audience: ${{ github.server_url }}/${{ github.repository_owner }}
          env-slug: terraform-common
          project-slug: terraform
          identity-id: ${{ vars.INFISICAL_IDENTITY_ID }}
          export-type: env

      - name: Fetch project secrets from Infisical
        uses: Infisical/secrets-action@8802effbe453d0576cd923567dcc2c97a1f54058 # ratchet:Infisical/secrets-action@v1.0.15
        with:
          domain: https://eu.infisical.com
          method: oidc
          oidc-audience: ${{ github.server_url }}/${{ github.repository_owner }}
          env-slug: terraform-oci-core
          project-slug: terraform
          identity-id: ${{ vars.INFISICAL_IDENTITY_ID }}
          export-type: env

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -out=tfplan
        continue-on-error: true

      - name: Post Plan to PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { execSync } = require('child_process');
            const branch = context.ref.replace('refs/heads/', '');

            // Find PR for this branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (prs.length === 0) {
              console.log('No open PR found for this branch, skipping comment');
              return;
            }

            const prNumber = prs[0].number;
            let plan = '';
            try {
              plan = execSync('terraform show -no-color tfplan', { maxBuffer: 10 * 1024 * 1024 }).toString();
            } catch (e) {
              plan = 'Failed to get plan output';
            }
            if (plan.length > 60000) plan = plan.substring(0, 60000) + '\n...(truncated)';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes('Terraform Plan'));
            if (existing) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
              });
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `#### Terraform Plan\n\`\`\`hcl\n${plan}\n\`\`\``
            });

      - name: Exit on Plan Failure
        if: steps.plan.outcome == 'failure'
        run: exit 1
